// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id               String   @id @default(cuid())
  email            String   @unique
  password         String
  nome             String
  cognome          String
  telefono         String?
  sede             String   @default("Alba") // Alba, Neive, Mont√†
  categoriaPatente String   @default("B") // AM, A1, A2, A3, B
  resetToken       String?  // Token per reset password
  resetTokenExpiry DateTime? // Scadenza token reset
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  giftLists GiftList[]
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nome      String
  ruolo     String   @default("admin") // 'admin', 'superadmin'
  attivo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GiftList {
  id          String   @id @default(cuid())
  studentId   String
  titolo      String
  descrizione String?
  shareToken  String   @unique
  attiva      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  giftItems  GiftItem[]
  
  @@index([studentId])
  @@index([shareToken])
}

model GiftItem {
  id              String   @id @default(cuid())
  giftListId      String
  tipo            String   // 'iscrizione', 'guida', 'esame'
  descrizione     String
  importoTarget   Float
  importoRaccolto Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  giftList      GiftList       @relation(fields: [giftListId], references: [id], onDelete: Cascade)
  contributions Contribution[]
  
  @@index([giftListId])
}

model Contribution {
  id              String   @id @default(cuid())
  giftItemId      String
  nome            String   // Nome di chi contribuisce
  email           String?
  importo         Float
  messaggio       String?
  metodoPagamento String   // 'satispay', 'bonifico'
  stato           String   @default("draft") // 'draft', 'pending', 'completed', 'failed', 'pending_verification', 'rejected'
  ricevutaPath    String?  // Path del file PDF della ricevuta (solo per Satispay) - DEPRECATO
  ricevutaBase64  String?  // Base64 del file PDF ricevuta (Vercel-compatible)
  ricevutaName    String?  // Nome originale del file ricevuta
  contabile       String?  // Numero contabile per bonifici
  bonificoBase64  String?  // Base64 del file PDF bonifico (Vercel-compatible)
  bonificoName    String?  // Nome originale del file bonifico
  note            String?  // Note admin (motivo rifiuto, ecc.)
  dataContributo  DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  giftItem GiftItem  @relation(fields: [giftItemId], references: [id], onDelete: Cascade)
  payment  Payment?
  
  @@index([giftItemId])
}

model Payment {
  id             String   @id @default(cuid())
  contributionId String   @unique
  transactionId  String?  @unique
  stato          String   @default("pending") // 'pending', 'completed', 'failed'
  metadata       String?  // JSON con dati aggiuntivi
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  contribution Contribution @relation(fields: [contributionId], references: [id], onDelete: Cascade)
  
  @@index([transactionId])
}
